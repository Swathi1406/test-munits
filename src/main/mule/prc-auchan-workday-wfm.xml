<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:s3="http://www.mulesoft.org/schema/mule/s3"
      xmlns:file="http://www.mulesoft.org/schema/mule/file"
      xmlns:os="http://www.mulesoft.org/schema/mule/os"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp"
      xmlns:http="http://www.mulesoft.org/schema/mule/http"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:crypto="http://www.mulesoft.org/schema/mule/crypto" 
       xmlns:schedulers="http://www.mulesoft.org/schema/mule/schedulers" xmlns:objectstore="http://www.mulesoft.org/schema/mule/objectstore" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd 
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
        http://www.mulesoft.org/schema/mule/core           http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/sftp           http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd
        http://www.mulesoft.org/schema/mule/http           http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/ee/core        http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/crypto         http://www.mulesoft.org/schema/mule/crypto/current/mule-crypto.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/s3 http://www.mulesoft.org/schema/mule/s3/current/mule-s3.xsd">

    <sub-flow name="workday_wfm_Sub_Flow" doc:id="1e52184a-2b6f-4449-bcec-356cd48c264f">
	<logger level="INFO" message="Reading Flow configurations" doc:name="Log that Flow Config initialized" category="com.auchan.prc-auchan-workday-wfm"/>
		<ee:transform doc:name="Build Input/Output Filenames">
        <ee:message>
        </ee:message>
			<ee:variables >
				<ee:set-variable resource="dwls/varConfig.dwl" variableName="varConfig" />
			</ee:variables>
    
</ee:transform>
	<try doc:name="Try" doc:id="2ca329fd-236f-4948-ba43-e34c82835a2b" >
			<sftp:read config-ref="Auchan_SFTP_Config" path="#[vars.varConfig.InputFileName]" doc:name="SFTP Read input file" timeBetweenSizeCheckUnit="MICROSECONDS" target="varOriginalFilePayload" outputMimeType="text/plain" outputEncoding="ISO-8859-15"/>
			<!-- [STUDIO:"Read input file"]<file:read doc:name="Read input file" doc:id="381f4d81-7194-47ba-9b1a-f22374c518e7" config-ref="File_Config" path="#[vars.varConfig.InputFileName&#93;" outputMimeType="text/plain" target="varOriginalFilePayload" outputEncoding="ISO-8859-15"/> [STUDIO] -->
		</try>
		<choice doc:name="PGP Optional">
            <when expression="#[((vars.varConfig.EncryptionFlag) as Boolean)]">
                <logger level="INFO" message="#['Decrypting (PGP) ' ++ (vars.inputFileInfo.originalFileName default 'current file')]"/>
                <crypto:pgp-decrypt config-ref="Crypto_Pgp" doc:name="PGP Decrypt" target="varOriginalFilePayload">
					<crypto:content ><![CDATA[#[vars.varOriginalFilePayload]]]></crypto:content>
				</crypto:pgp-decrypt>
            </when>
            <otherwise>
                <logger level="INFO" message="PGP disabled" category="com.auchan.prc-auchan-workday-wfm"/>
            </otherwise>
        </choice>
		<set-variable value="#[%dw 2.0&#10;output application/dw&#10;---&#10;readUrl(&quot;classpath://dwls/&quot; ++ vars.varConfig.dwlMappingFile, 'text/plain')]" doc:name="varMapping" doc:id="16c7afb8-fc2f-4011-8e78-afd605a4699c" variableName="varMapping"/>
		<ee:dynamic-evaluate doc:name="Dynamic Evaluate" doc:id="8b3f35f6-f097-4eb0-9d2c-b10a4026b39b" expression="#[vars.varMapping]" target="varTransformedFilePayload"/>
		<flow-ref doc:name="Upload to Oracle" doc:id="0a63a53a-acac-4292-aa34-870ddaefac12" name="upload-to-oracle-subflow" />
		<flow-ref doc:name="GDrive Workday" doc:id="3e877ddc-c5fc-4391-b3d8-7ab04714355b" name="publish-gdrive-workday" targetValue="#[vars.originalPayload]" />
		<flow-ref doc:name="GDrive Tlantic" doc:id="ffcd6b82-8605-40f4-b4ac-898d645b7006" name="publish-gdrive-tlantic" targetValue="#[vars.ouput]" />
    
</sub-flow>
	<sub-flow name="upload-to-oracle-subflow" doc:name="Oracle Cloud Upload Subflow">
        <logger level="INFO" message="#['Uploading to Oracle Cloud: ' ++ vars.varConfig.OutputFileName]" doc:name="Log that Oracle flow started" category="com.auchan.prc-auchan-workday-wfm"/>
        <s3:put-object doc:name="Put Object" doc:id="719f2f91-a785-4ebb-a1c9-1e72df0768da" config-ref="Amazon_S3_Configuration" bucketName="AuchanIntegration01" key="#[vars.varConfig.OutputFileName]" contentType="application/csv">
			<s3:content ><![CDATA[#[vars.varTransformedFilePayload]]]></s3:content>
		</s3:put-object>
        <logger level="INFO" message="#['File uploaded to Oracle Cloud successfully: ' ++ vars.varConfig.OutputFileName]" doc:name="Log that Oracle flow ended" category="com.auchan.prc-auchan-workday-wfm"/>
    </sub-flow>
	<sub-flow name="publish-gdrive-tlantic" doc:name="Publish GDrive Tlantic">
        <logger level="INFO" message="#['GDrive (Tlantic) upload: ' ++ vars.varConfig.OutputFileName]" doc:name="Log that Tlantic GDrive started" category="com.auchan.prc-auchan-workday-wfm"/>
        
        <set-variable value="${secure::google.auchan.parentfolder.tlantic}" doc:name="varParentFolder" doc:id="978c6c68-8db1-4b33-8b62-4f19cceee555" variableName="varParentFolder" />
		<set-variable value="#[vars.varConfig.OutputFileName]" doc:name="varOutputFileName" doc:id="120c369f-30cd-434e-971f-4f6bcc7213f5" variableName="varOutputFileName"/>
		<set-payload value='#[%dw 2.0&#10;import toBase64 from dw::core::Binaries&#10;output text/plain&#10;---&#10;toBase64(write(vars.varTransformedFilePayload, "application/csv"))]' doc:name="Set Payload file content" doc:id="2e727882-cd54-4779-9d8d-704aa9b20c9d" />
		<flow-ref doc:name="googledrive-upload-fileSub_Flow" doc:id="24f71926-2bcd-40a3-ba65-658393aa473c" name="googledrive-upload-fileSub_Flow"/>
		<logger level="INFO" message="#['GDrive (Tlantic) upload done: ' ++ vars.varConfig.OutputFileName]" doc:name="Log that Tlantic upload susccess" category="com.auchan.prc-auchan-workday-wfm"/>
    
</sub-flow>
	<sub-flow name="publish-gdrive-workday" doc:name="Publish GDrive Workday (Original)">
        <logger level="INFO" message="#['GDrive (Workday) upload: ' ++ vars.varConfig.WorkdayFileName]" doc:name="Log that Workday GDrive started" category="com.auchan.prc-auchan-workday-wfm"/>
        <set-variable value="${secure::google.auchan.parentfolder.workday}" doc:name="varParentFolder" doc:id="9873454d-ba30-4be2-a19c-50a570402156" variableName="varParentFolder" />
		<set-variable value="#[vars.varConfig.WorkdayFileName]" doc:name="varOutputFileName" doc:id="4ff6dac4-51c2-421d-a904-647482ece31a" variableName="varOutputFileName" />
		<set-payload value="#[%dw 2.0&#10;import toBase64 from dw::core::Binaries&#10;output text/plain&#10;---&#10;toBase64(vars.varOriginalFilePayload as Binary)]" doc:name="Set Payload file content" doc:id="47da032b-88c7-47f2-a63e-5a136ae60947" />
		<flow-ref doc:name="googledrive-upload-fileSub_Flow" doc:id="54b757c6-7eba-4da3-8fc0-fd717dadd5f1" name="googledrive-upload-fileSub_Flow"/>
		<logger level="INFO" message="#['GDrive (Workday) upload done: ' ++ vars.varConfig.WorkdayFileName]" doc:name="Log that Workday upload sucess" category="com.auchan.prc-auchan-workday-wfm"/>
	
</sub-flow>
	</mule>